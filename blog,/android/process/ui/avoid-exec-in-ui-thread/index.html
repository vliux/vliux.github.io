<meta charset="utf-8">
<title>Avoid Runtime.exec in UI thread &#8211; vliux's story</title>
<meta name="description" content="">
<meta name="keywords" content="">


<meta property="og:locale" content="en_US">
<meta property="og:title" content="Avoid Runtime.exec in UI thread &#8211; vliux's story">
<meta property="og:description" content="Several days ago I saw a ANR during monkey test. The ANR trace looked like this."main" prio=5 tid=1 MONITOR  at java....">
<meta property="og:url" content="http://vliux.me/blog,/android/process/ui/avoid-exec-in-ui-thread/">
<meta property="og:site_name" content="vliux's story">


<link href="http://vliux.me/feed.xml" type="application/atom+xml" rel="alternate" title="vliux's story Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Type -->
<link rel="stylesheet" href="http://vliux.me/assets/css/crimson.css" rel='stylesheet' type='text/css' />
<link href="/assets/css/sourcesanspro.css" rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="http://vliux.me/assets/css/entypo.css" media="all">

<!-- In order to use Calendas Plus, you must first purchase it. Then, create a font-face package using FontSquirrel.
<link rel='stylesheet' href='http://vliux.me/assets/cal.css' media='all' />
-->



<!-- For all browsers -->
<link rel="stylesheet" href="http://vliux.me/assets/css/i.css">

<!-- Fresh Squeezed jQuery -->

<!-- vliux: not sure what does this do for my site. But it slows the page loading, especially as google is blocked -->
<!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>-->

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="http://vliux.me/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://vliux.me/favicon.ico">

<div id="bump">
  <body class="">
    <header class="site-header darken">
      <div class="wrap">
        <hgroup>
          <h1><a href="/">vliux's story</a></h1>
        </hgroup>
        <a href="#nav" class="menu"><span class='icons'>☰</span></a>
        <nav role="navigation">
          <ul>
            <li>
              <a href="/gallery" title="Gallery">Gallery</a>
            </li>

            <li>
              <a href="/blog" title="Blog">Blog</a>
            </li>

            
                <li><a href="https://500px.com/xinliu4" target="_blank">500px</a></li>
            
                <li><a href="https://500px.me/vliux" target="_blank">500px中国</a></li>
            
                <li><a href="http://vliux.me/about" >About</a></li>
            

          </ul>
        </nav>
      </div>
    </header>

<!-- tencent analysis -->
<script type="text/javascript" src="http://tajs.qq.com/stats?sId=61337454" charset="UTF-8"></script>

<section class="article">

<!-- 
  <div class="overlay"></div>
  <div class="featured-image" style="background-image: url(http://vliux.me/images/typewriter.jpg)"></div>
 -->


      <article class="wrap post">
        <header class="post-header">
          <hgroup>
            <h1>Avoid Runtime.exec in UI thread</h1>
            <p class="date">Sep 24, 2015</p>
            <p class="intro"></p>
          </hgroup>
        </header>
        
        <div class="content">
            Several days ago I saw a ANR during monkey test. The ANR trace looked like this.
<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="s">"main"</span> <span class="n">prio</span><span class="o">=</span><span class="mi">5</span> <span class="n">tid</span><span class="o">=</span><span class="mi">1</span> <span class="n">MONITOR</span>
  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ProcessManager</span><span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="n">ProcessManager</span><span class="o">.</span><span class="na">java</span><span class="o">:~</span><span class="mi">206</span><span class="o">)</span>
  <span class="o">-</span> <span class="n">waiting</span> <span class="n">to</span> <span class="n">lock</span> <span class="o">&lt;</span><span class="mh">0x410bc8b0</span><span class="o">&gt;</span> <span class="o">(</span><span class="n">a</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">HashMap</span><span class="o">)</span> <span class="n">held</span> <span class="n">by</span> <span class="n">tid</span><span class="o">=</span><span class="mi">25</span> <span class="o">(</span><span class="n">Thread</span><span class="o">-</span><span class="mi">176</span><span class="o">)</span>
  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ProcessBuilder</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">ProcessBuilder</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">195</span><span class="o">)</span>
<span class="s">"Thread-176"</span> <span class="n">prio</span><span class="o">=</span><span class="mi">5</span> <span class="n">tid</span><span class="o">=</span><span class="mi">25</span> <span class="n">NATIVE</span>
  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ProcessManager</span><span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="n">Native</span> <span class="n">Method</span><span class="o">)</span>
  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ProcessManager</span><span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="n">ProcessManager</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">209</span><span class="o">)</span>
  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Runtime</span><span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">168</span><span class="o">)</span></code></pre></figure>

At the exact moment of ANR, Thread-176 was executing a shell command with Runtime.getRuntime.exec(), which entered the lock section in ProcessManager.exec().
<figure class="highlight"><pre><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="n">Process</span> <span class="nf">exec</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">taintedCommand</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">taintedEnvironment</span><span class="o">,</span> <span class="n">File</span> <span class="n">workingDirectory</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">redirectErrorStream</span><span class="o">){</span>
        <span class="c1">// Ensure onExit() doesn't access the process map before we add our entry.</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">processReferences</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">processReferences</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">pid</span><span class="o">,</span> <span class="n">processReference</span><span class="o">);</span>
            <span class="cm">/*
             * This will wake up the child monitor thread in case there
             * weren't previously any children to wait on.
             */</span>
            <span class="n">processReferences</span><span class="o">.</span><span class="na">notifyAll</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">process</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></figure>

So when our Main thread tried to execute a command later, it's blocked for a long time which caused the ANR. The "processReferences" is a HashMap which records the exit value of each child process. When ProcessManager is initialized, it creates a Thread which checks the status of every child in an infinite loop. When the status of one child process is exited or signaled, it will set the exit value accordingly.
<figure class="highlight"><pre><code class="language-java" data-lang="java">    <span class="kd">private</span> <span class="nf">ProcessManager</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// Spawn a thread to listen for signals from child processes.</span>
        <span class="n">Thread</span> <span class="n">reaperThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">ProcessManager</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">())</span> <span class="o">{</span>
            <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">watchChildren</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span></code></pre></figure>

The case is clear. We should prevent calling any method which takes a lock. With lock involved, you won't know how long your UI thread will wait before other threads release the lock. Runtime.exec() should be invoked asynchronously instead. If your UI relies on the result of exec(), place it at a earlier stage and cache it for later reference. In some extreme case, use NDK to fork the process.


        </div>

      <!-- vliux: google+ comments -->
      <!--<<script src="https://apis.google.com/js/plusone.js">
      </script>
      <p><div class="g-comments"
        data-href="http://vliux.me/blog,/android/process/ui/avoid-exec-in-ui-thread/"
        data-width="642"
        data-first_party_property="BLOGGER"
        data-view_type="FILTERED_POSTMOD">
      </div></p>-->

      <!--<a class="share" href="https://twitter.com/intent/tweet?text=&quot;Avoid Runtime.exec in UI thread&quot;%20http://vliux.me/blog,/android/process/ui/avoid-exec-in-ui-thread/%20via%20&#64;" data-dnt="true">Share</a>
      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>-->

      <!-- disqus comments page is blocked, so it slows the page loading dramatically 
      
      <aside class="disqus">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'vliuxonsoftware'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = (location.protocol == 'https:' ? location.protocol : 'https:') + '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </aside>
      
      -->

      <!-- vliux: google+ share is blocked as well
      <br/><br/>
      <script type="text/javascript">
         (function() {
             var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
             po.src = 'https://apis.google.com/js/plusone.js';
             var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
      </script>
      <g:plus action="share" href="http://vliux.me/blog,/android/process/ui/avoid-exec-in-ui-thread/"></g:plus>
      -->
      </article>

    </section>
</div>

<div class="push"></div>
  <footer>
    <aside class="wrap">
      <ol class="prev-posts">
        <p class="list-title">Recent Posts</p>
         <!-- for1 -->
            <li>
              <span class="recent-title"><a href="http://vliux.me/gallery/hangzhou/" title="杭州">杭州 </a></span>
              <span class="date">Apr 10, 2017</span>
            </li>
         <!-- for1 -->
            <li>
              <span class="recent-title"><a href="http://vliux.me/gallery/prague/" title="布拉格Prague">布拉格Prague </a></span>
              <span class="date">Apr 09, 2017</span>
            </li>
         <!-- for1 -->
            <li>
              <span class="recent-title"><a href="http://vliux.me/gallery/qtj-sunset/" title="钱塘江日落">钱塘江日落 </a></span>
              <span class="date">Mar 20, 2017</span>
            </li>
        
      </ol>

      <div class="social">
        <ul>
            <li><a id="mail" href="mailto:swordmanliuxin@gmail.com"><span class="foot-link">@Email</span></a></li>

            
            <li><a id="500px" href="https://500px.com/xinliu4" target="_blank"><span class="foot-link">500px</span></a></li>
            

            
            <li><a id="500pxc" href="https://500px.me/vliux" target="_blank"><span class="foot-link">500px中国</span></a></li>
            

            
            <li><a id="insta" href="https://www.instagram.com/vliux" target="_blank"><span class="foot-link">Instagram</span></a></li>
            
        </ul>
    </div>
    </aside>
    <small>&copy; 2017 vliux. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://jekyll.gtat.me/about">Balzac</a> theme.</small>
  </footer>

  <!-- If they're out, get some from the cellar -->
  <script>window.jQuery || document.write('<script src="http://vliux.me/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
  <script src="http://vliux.me/assets/js/retina.min.js"></script>

  <!-- Custom JS -->
  <script src="http://vliux.me/assets/js/scripts.js"></script>


  </body>
</html>

