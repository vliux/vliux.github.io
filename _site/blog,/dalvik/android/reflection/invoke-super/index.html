<meta charset="utf-8">
<title>Invoke super method with reflection &#8211; vliux's story</title>
<meta name="description" content="">
<meta name="keywords" content="">


<meta property="og:locale" content="en_US">
<meta property="og:title" content="Invoke super method with reflection &#8211; vliux's story">
<meta property="og:description" content="Occasionally, I need to invoke a method, which is defined in super class, instead of the derived class, with Java ref...">
<meta property="og:url" content="http://localhost:4000/blog,/dalvik/android/reflection/invoke-super/">
<meta property="og:site_name" content="vliux's story">


<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="vliux's story Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Type -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/crimson.css" rel='stylesheet' type='text/css' />
<link href="/assets/css/sourcesanspro.css" rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="http://localhost:4000/assets/css/entypo.css" media="all">

<!-- In order to use Calendas Plus, you must first purchase it. Then, create a font-face package using FontSquirrel.
<link rel='stylesheet' href='http://localhost:4000/assets/cal.css' media='all' />
-->



<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/i.css">

<!-- Fresh Squeezed jQuery -->

<!-- vliux: not sure what does this do for my site. But it slows the page loading, especially as google is blocked -->
<!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>-->

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="http://localhost:4000/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">

<div id="bump">
  <body class="">
    <header class="site-header darken">
      <div class="wrap">
        <hgroup>
          <h1><a href="/">vliux's story</a></h1>
        </hgroup>
        <a href="#nav" class="menu"><span class='icons'>☰</span></a>
        <nav role="navigation">
          <ul>
            <li>
              <a href="/gallery" title="Gallery">Gallery</a>
            </li>

            <li>
              <a href="/blog" title="Blog">Blog</a>
            </li>

            
                <li><a href="https://500px.com/xinliu4" target="_blank">500px</a></li>
            
                <li><a href="https://500px.me/vliux" target="_blank">500px中国</a></li>
            
                <li><a href="http://localhost:4000/about" >About</a></li>
            

          </ul>
        </nav>
      </div>
    </header>

<!-- tencent analysis -->
<script type="text/javascript" src="http://tajs.qq.com/stats?sId=61337454" charset="UTF-8"></script>

<section class="article">

<!-- 
  <div class="overlay"></div>
  <div class="featured-image" style="background-image: url(http://localhost:4000/images/typewriter.jpg)"></div>
 -->


      <article class="wrap post">
        <header class="post-header">
          <hgroup>
            <h1>Invoke super method with reflection</h1>
            <p class="date">Jul 10, 2015</p>
            <p class="intro"></p>
          </hgroup>
        </header>
        
        <div class="content">
            Occasionally, I need to invoke a method, which is defined in super class, instead of the derived class, with Java reflection.
My first approach, which is the wrong approach, was as follows:
<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">SuperClass</span> <span class="n">derivedObj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DerivedClass</span><span class="o">();</span>
<span class="n">Method</span> <span class="n">superMethod</span> <span class="o">=</span> <span class="n">derivedObj</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSuperClass</span><span class="o">().</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"funcName"</span><span class="o">);</span>
<span class="n">superMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">derivedObj</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span></code></pre></figure>

Unfortunately, with this solution, the method overrided in the DERIVED class was called. It's counter-intuitive, as the Method instance is obtained from the super class. In order to explain this, I need to take a look at the framework implementation:
<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// in java.lang.reflect.Method</span>
<span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">receiver</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">args</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">EmptyArray</span><span class="o">.</span><span class="na">OBJECT</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="nf">invokeNative</span><span class="o">(</span><span class="n">receiver</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">declaringClass</span><span class="o">,</span> <span class="n">parameterTypes</span><span class="o">,</span> <span class="n">returnType</span><span class="o">,</span> <span class="n">slot</span><span class="o">,</span> <span class="n">flag</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="c1">// java_lang_reflect_Method.cpp
</span><span class="k">static</span> <span class="kt">void</span> <span class="nf">Dalvik_java_lang_reflect_Method_invokeNative</span><span class="p">(</span><span class="k">const</span> <span class="n">u4</span><span class="o">*</span> <span class="n">args</span><span class="p">,</span> <span class="n">JValue</span><span class="o">*</span> <span class="n">pResult</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ignore thisPtr in args[0]
</span>    <span class="n">Object</span><span class="o">*</span> <span class="n">methObj</span> <span class="o">=</span> <span class="p">(</span><span class="n">Object</span><span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>        <span class="c1">// null for static methods
</span>    <span class="n">ClassObject</span><span class="o">*</span> <span class="n">declaringClass</span> <span class="o">=</span> <span class="p">(</span><span class="n">ClassObject</span><span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
    <span class="p">......</span>
    <span class="k">const</span> <span class="n">Method</span><span class="o">*</span> <span class="n">meth</span><span class="p">;</span>
    <span class="n">meth</span> <span class="o">=</span> <span class="n">dvmSlotToMethod</span><span class="p">(</span><span class="n">declaringClass</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
    <span class="p">......</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">dvmInvokeMethod</span><span class="p">(</span><span class="n">methObj</span><span class="p">,</span> <span class="n">meth</span><span class="p">,</span> <span class="n">argList</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">returnType</span><span class="p">,</span>
                <span class="n">noAccessCheck</span><span class="p">);</span>
    <span class="p">......</span>
<span class="p">}</span></code></pre></figure>
'slot' is the field defined in java.lang.reflection.Method (Kitkat and before versions). For this case, it refers to the index inside the virtual method array, which points to the method definition in VM.
<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="c1">// AOSP/dalvik/vm/reflect/Reflect.cpp
</span><span class="n">Method</span><span class="o">*</span> <span class="nf">dvmSlotToMethod</span><span class="p">(</span><span class="n">ClassObject</span><span class="o">*</span> <span class="n">clazz</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">slot</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">slot</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="n">clazz</span><span class="o">-&gt;</span><span class="n">directMethodCount</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">&amp;</span><span class="n">clazz</span><span class="o">-&gt;</span><span class="n">directMethods</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="n">clazz</span><span class="o">-&gt;</span><span class="n">virtualMethodCount</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">&amp;</span><span class="n">clazz</span><span class="o">-&gt;</span><span class="n">virtualMethods</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>
For an overrided method, it has the same slot value for both the super and derived classes. But in my case the 'declaringClass' passed into dvmSlotToMethod() is the derived class. So the method defined in the derived class was found and executed.
<br><br>
Fix this problem is not as easy as finding the root cause. The invokeNative() method obtains the class from the object(which is the class definition of the derived class), which prevents any solution from the Java level. In our project we have composed a native method which is similar with invokeNative(), but instead it fetchs the super class definition. If you have any better solution, don't hesitate to tell me :)

        </div>

      <!-- vliux: google+ comments -->
      <!--<<script src="https://apis.google.com/js/plusone.js">
      </script>
      <p><div class="g-comments"
        data-href="http://vliux.me/blog,/dalvik/android/reflection/invoke-super/"
        data-width="642"
        data-first_party_property="BLOGGER"
        data-view_type="FILTERED_POSTMOD">
      </div></p>-->

      <!--<a class="share" href="https://twitter.com/intent/tweet?text=&quot;Invoke super method with reflection&quot;%20http://vliux.me/blog,/dalvik/android/reflection/invoke-super/%20via%20&#64;" data-dnt="true">Share</a>
      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>-->

      <!-- disqus comments page is blocked, so it slows the page loading dramatically 
      
      <aside class="disqus">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'vliuxonsoftware'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = (location.protocol == 'https:' ? location.protocol : 'https:') + '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </aside>
      
      -->

      <!-- vliux: google+ share is blocked as well
      <br/><br/>
      <script type="text/javascript">
         (function() {
             var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
             po.src = 'https://apis.google.com/js/plusone.js';
             var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
      </script>
      <g:plus action="share" href="http://vliux.me/blog,/dalvik/android/reflection/invoke-super/"></g:plus>
      -->
      </article>

    </section>
</div>

<div class="push"></div>
  <footer>
    <aside class="wrap">
      <ol class="prev-posts">
        <p class="list-title">Recent Posts</p>
         <!-- for1 -->
            <li>
              <span class="recent-title"><a href="http://localhost:4000/gallery/qtj-sunset/" title="钱塘江日落">钱塘江日落 </a></span>
              <span class="date">Mar 20, 2017</span>
            </li>
         <!-- for1 -->
            <li>
              <span class="recent-title"><a href="http://localhost:4000/gallery/flower-life/" title="花落花起">花落花起 </a></span>
              <span class="date">Mar 20, 2017</span>
            </li>
         <!-- for1 -->
            <li>
              <span class="recent-title"><a href="http://localhost:4000/gallery/macro-static/" title="雨后静物">雨后静物 </a></span>
              <span class="date">Mar 17, 2017</span>
            </li>
        
      </ol>

      <div class="social">
        <ul>
            <li><a id="mail" href="mailto:swordmanliuxin@gmail.com"><span class="foot-link">@Email</span></a></li>

            
            <li><a id="500px" href="https://500px.com/xinliu4" target="_blank"><span class="foot-link">500px</span></a></li>
            

            
            <li><a id="500pxc" href="https://500px.me/vliux" target="_blank"><span class="foot-link">500px中国</span></a></li>
            

            
            <li><a id="insta" href="https://www.instagram.com/vliux" target="_blank"><span class="foot-link">Instagram</span></a></li>
            
        </ul>
    </div>
    </aside>
    <small>&copy; 2017 vliux. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://jekyll.gtat.me/about">Balzac</a> theme.</small>
  </footer>

  <!-- If they're out, get some from the cellar -->
  <script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
  <script src="http://localhost:4000/assets/js/retina.min.js"></script>

  <!-- Custom JS -->
  <script src="http://localhost:4000/assets/js/scripts.js"></script>


  </body>
</html>

